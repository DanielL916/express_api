// /**
//  * Created by zenit1 on 03/07/2016.
//  */
"use strict";

const path        = require('path');
const CommonUtils = require('../../src/utils/CommonUtils');
//var config = require('../../../config/Config');

//process.env.BEAME_LOG_LEVEL = "DEBUG";

//process.env.BEAME_FORCE_EDGE_FQDN = "z503ms2nznaqp6i4.bqnp2d2beqol13qn.v1.d.beameio.net";
process.env.EXTERNAL_OCSP_FQDN = 'i6zirg0jsrzrk3dk.mpk3nobb568nycf5.v1.d.beameio.net';
/**
 * Created by USER on 24/01/2017.
 */
"use strict";
const BeameLogger  = require('../../src/utils/Logger');
const BeameStore   = require('../../src/services/BeameStoreV2');
const AuthToken    = require('../../src/services/AuthToken');
const Credential   = require('../../src/services/Credential');
const ProvisionApi = require('../../src/services/ProvisionApi');
const fqdn         = 'mbvw24gx0o7ho2dp.jp016rz81zn3z72t.v1.d.beameio.net'; // 'bqnp2d2beqol13qn.h40d7vrwir2oxlnn.v1.d.beameio.net'; //'mpk3nobb568nycf5.v1.d.beameio.net'; //'lso3234x4lgd9ffc.x2cyw3t8yt4r2hkh.v1.d.beameio.net';//
const parent_fqdn  = 'wtr62qbwcq3f6aco.v1.d.beameio.net';
const openssl      = new (require('../../src/utils/OpenSSLWrapper'))();
const store        = new BeameStore();
const provisionApi = new ProvisionApi();
const ocsp         = require('ocsp');
const https = require('https');


// https.get("https://sns.us-east-1.amazonaws.com/SimpleNotificationService-b95095beb82e8f6a046b3aafc7f4149a.pem", function (res) {
// 	var chunks = [];
//
// 	if(res.statusCode !== 200){
// 		return cb(new Error('Certificate could not be retrieved'));
// 	}
//
// 	res
// 		.on('data', function (data) {
// 			chunks.push(data.toString());
// 		})
// 		.on('end', function () {
// 			console.log('huj')
// 		});
// }).on('error', e=>{
// 	console.error(e)
// });



//region Resource API


// const http    = require('http');
// const request = require('request');
//
// store.find('lj40kh04yff6omkg.v1.d.beameio.net').then(cred => {
//
// 	cred.checkOcspStatus(cred,true).then(d=>{
// console.log(d);
// 	})

	// cred.generateOcspRequest(cred).then(req => {
	//
	//
	// 	ocsp.getOCSPURI(cred.getKey("X509"), (err, uri) => {
	//
	// 		const url = require('url');
	// 		let opt   = Object.assign({}, url.parse(uri), {
	// 			method:  'POST',
	// 			headers: {
	// 				'Content-Type':   'application/ocsp-request',
	// 				'Content-Length': req.data.length
	// 			}
	// 		});
	//
	//
	// 		http.request(opt, (response) => {
	// 				if (response.statusCode < 200 || response.statusCode >= 400) {
	// 					return done(
	// 						new Error('Failed to obtain OCSP response: ' + response.statusCode));
	// 				}
	//
	// 				let chunks = [];
	// 				response.on('readable', function () {
	// 					let chunk = response.read();
	// 					if (!chunk)
	// 						return;
	// 					chunks.push(chunk);
	// 				});
	// 				response.on('end', function () {
	// 					let raw = Buffer.concat(chunks);
	//
	// 					ocsp.verify({
	// 						request: req,
	// 						response: raw
	// 					}, (err,resp)=>{
	// 						console.log(resp);
	// 					});
	// 				});
	// 			})
	// 			.on('error', done)
	// 			.end(req.data);
	//
	//
	// 		// request.post(
	// 		// 	uri,
	// 		// 	options,
	// 		// 	(error, response, body) => {
	// 		// 		console.log(body)
	// 		// 	}
	// 		// );
	//
	// 	});
	//
	//
	// });
// }).catch(e => {
// 	console.error(e);
// 	process.exit(1)
// });

//endregion


// const config      = require('../../config/Config');
// store.find('ww2hweoemrb20qdc.os8flrpmtgs5ifw6.v1.d.beameio.net').then(cred=>{
//
//
// 	  let token  = AuthToken.create("huy",cred);
//
// 	  if(token){
//       AuthToken.validate(token).then(authToken=>{
// 	      console.log(authToken)
//       }).catch(e=>{
// 	      console.error(e)
//       })
//      }
//
//
//
//  // cred.checkOcspStatus(cred,true).then(resp=>{
// 	//  console.log(resp)
//  // }).catch(e=>{
// 	//  console.error(e)
//  // });
//
//
// }).catch(e=>{
//  console.error(e)
// });


//
// let _fqdn = "ak8ivtu7qrh1amat.sls8vm7t4hxqmb2i.v1.d.beameio.net";
// store.find(_fqdn).then(cred=>{
//
// 	let authToken = AuthToken.create(_fqdn, cred);
//
// 	const url = `https://u5awzf72acmvbqzp.v1.d.beameio.net/http_get`;
//
// 	const request = require('request');
//
//
// 	let opt = {
// 		url:      url,
// 		headers:  {
// 			'X-BeameAuthToken': authToken,
// 			'Content-Type':     'application/json',
// 		},
// 		method:   'GET',
// 		encoding: 'UTF-8',
// 		body : JSON.stringify({url:'http://secure.globalsign.com/beameioca1.crt'})
// 	};
//
// 	let opt1 = {
// 		url:     "http://secure.globalsign.com/beameioca1.crt",
// 		method:   'GET',
// 		encoding:null
// 	};
//
// 	request(opt1, (error, response, body) => {
// 		if (response.statusCode < 200 || response.statusCode >= 400) {
//
// 		}
// 		else {
// 			const fs = require('fs'),
// 			      certPath = './cert.pem';
//
// 			fs.writeFileSync(certPath, body);
// 			console.log(1);
// 		}
//
// 	});
//
//
// }) .catch(e=>{
// 	console.error(e);
// });
//


// if(cred){
// 	// cred.revokeCert('usv0xzhe2126yij0.x5rtow8hokulgqyk.v1.d.beameio.net','k3d7vnx5qohi4h3w.usv0xzhe2126yij0.v1.d.beameio.net').then(res=>{
// 	// 	console.log(res)
// 	// }).catch(e=>{
// 	// 	console.error(e);
// 	// });
//
// 	AuthToken.createAsync(null,cred).then(token=>{
// 		console.log(token);
//
// 		AuthToken.validate(token).then(()=>{
// 			console.log('OK');
// 		}).catch(e=>{
// 			console.error(BeameLogger.formatError(e));
// 		})
// 	}).catch(e=>{
// 		console.error(BeameLogger.formatError(e));
// 	});
// }
//
//
// store.find('x6mkk25rzrokem87.ihhnal7vgo1rums1.v1.d.beame.io',true).then(cred=>{
// 	console.log(cred);
// }).catch(e=>{
// 	console.error(e);
// });
//
//const cred = store.getCredential('p2payp4q8f5ruo22.q6ujqecc83gg6fod.v1.d.beameio.net');
//
// const cred = new Credential(store);
//
// cred.createAuthTokenForCred('s6cbq5sr88k9eqg9.usv0xzhe2126yij0.v1.d.beameio.net').then(token=>{
//
// 	console.log(token);
// }).catch(e=>{
// 	console.error(e);
// });

//let  parents = cred.getParentsChain('cg0ez0soxdvk9u4k.iiuap0836sudr6ec.v1.d.beameio.net');

//console.log('parents',parents);

//console.log('filtered', parents.filter(x=>x.hasPrivateKey === true && x.expired === false));
// return;
// let withPk = parents.filter(x=>x.hasPrivateKey === true && !x.expired).sort( (a, b) => {
// 	return b.level - a.level;
// });
//
//console.log(withPk);

//
// let signature = cred.sign("huy");
//
//
// console.log(cred.checkSignature(signature));

// store.getRemoteCreds('itp5q6wemsnjs3yr.gf6guvdes7nufc0j.v1.p.beameio.net').then(payload=>{
// 	console.log(payload);
// }).catch(err=>{
// 	console.error(err);
// });
//
// function findCreds(fqdnPart){
// 	return new Promise((resolve) => {
// 			let list = store.list(null,{hasPrivateKey:true});
//
// 			const _isContains = (cred) =>{
// 				return cred.getKey("FQDN").indexOf(fqdnPart) >= 0;
// 			};
//
// 			resolve(list.filter(_isContains).map(item=>{return item.fqdn}));
// 		}
// 	);
// }

//var provisionApi = new ProvisionApi();
//console.log(JSON.stringify({fqdn:'bhot2v6z9azn691e.v1.p.beameio.net'}));

//region RENEW CERT
//  AuthToken.createAsync({fqdn:'k2rlliqayjau26xj.v1.d.beameio.net'},cred).then(authToken =>{
// 	 console.log(CommonUtils.stringify(authToken));
//  });

// cred.renewCert(JSON.parse(authToken),fqdn).then(meta=>{
//


// 	console.log(meta);
//
// }).catch(e=>{
// 	console.error(e);
// });
//endregion

//region Custom Entity
//const store = new BeameStore();
// let cred = new Credential(store);
// cred.createCustomEntityWithLocalCreds('tl5h1ipgobrdqsj6.v1.p.beameio.net', 'login' ,'Beame central login', 's@beame.io').then(meta=>{
// 	console.log(meta);
// }).catch(e=>{
// 	console.error(e);
// });
//endregion

// findCreds('wtr62qbwcq').then(list=>{
// 	console.log(list);
// });
// let authToken = AuthToken.create({fqdn},cred);
//
// console.log(authToken);
// return;

// let cred = new Credential(store);
// cred.createEntityWithLocalCreds('eav593lckcviof7q.x5rtow8hokulgqyk.v1.d.beameio.net', 'hno_edge_test1', 'noedge1232@example.com').then(meta=>{
// 	console.log(meta);
// //
// // 	var newFqdn = meta.fqdn;
// // 	var newCred = store.getCredential(newFqdn);
// //
// // 	var provisionApi = new ProvisionApi();
// // 	let authToken = AuthToken.create({newFqdn},newCred);
// //
// // 	provisionApi.postRequest('https://bl4liycf551p6xaz.v1.p.beameio.net/api/v1/node/cert/renew',{fqdn:newFqdn},function () {
// // 	console.log('revoked',arguments);
// // },authToken);
//
// }).catch(e=>{
// 	console.error(e);
//
// });


//
// var sign = { signedData: 'huy',
// 	signedBy: 'p2payp4q8f5ruo22.q6ujqecc83gg6fod.v1.d.beameio.net',
// 	signature: 'lX8x9AiTNME04LeJNBX6U990HPI/MXc5H1QwHal50fiOZdISNKq9Hd6G2I0j2Tm8YGfLeUEJTwtN9WRbvShMbG/0UoOlLKgW7TFXAydT8XehWrpkNlvNZjFWUFOPC3QvsVwricaYmCJGKmKJ0gN87gQBpYFwzb+DMaI81wIlbI/wxRylhDW7zl/kKuAYlUnsSQznwY7KFeZl8phvLf+Ht8Nh0lWM9HXBgGg1AJapG+B80bfH8Pkld2rqSaa22UdIlE8uRF1rjeef2ctEcGUlfghToxbiJp6eCCGUQ0qx6k8BRnS36gTYSsBom1HpYKwD5QiyzcEKlCR+COW0/cO+XQ==' };
//
// var creds = require('../../../src/cli/creds');
//
//
// let python = {"signedData": "{\"created_at\": 1477225485, \"data\": \"my optional arbitrary data\", \"valid_till\": 1477225785}", "signedBy": "jp016rz81zn3z72t.bqnp2d2beqol13qn.v1.d.beameio.net", "signature": "yVbWjlUE55sSu0ZitHIYJ1Ksd2HeTDEwfuPZ72oFQtQLKYnokpvEF7gFQSVQ8mNJrJEkssoVQ25/f3G2Cp/AM+4vGxbN5UAAXrPXOGn/h/qvuE1y+Ojlu/kp/J17q3uHmCwI76mVZ1Buu1GoT12YDdwgLpc1enF6pugr2f6svsUCZojZlDk8HaLnxKeov0eo4pzQofMEIcrhLsfKW/VGr1amyLZHOUaUh6wwisRxSshcE6leS8/8TGsQeDDh8zyHmFIVwgK5dJcQNEaHzUWSzCrA0G1KI2+OkjKl/iRrhLeTa+lk2tpx4XLuAIvZFpDugIfMoZIt1p0+DTvpECa/FA=="};
//
// let python_signature = JSON.stringify(python);

//
//  creds.exportCredentials('lnlee75661z8vsd3.v1.d.beameio.net','ntfustqgcjs5pmrw.p2payp4q8f5ruo22.v1.d.beameio.net',null,'lnlee75661z8vsd3.v1.d.beameio.net.txt',(error)=>{
//  	"use strict";
//  	console.log(arguments)
//  });

// creds.importCredentials('lnlee75661z8vsd3.v1.d.beameio.net.txt',error=>{
// 	console.log(arguments)
// });

//creds.importLiveCredentials('facebook.com');

// var creds = require('../../../src/cli/creds');
//
//
// creds.getCreds(null,null,'usxbxj0e4pi6wmf8.v1.d.beameio.net',null,function(error,data){
// 	"use strict";
// 	console.log(arguments);
// });


// var tests = require('../../unit_tests/test_create_credentials');
//
// tests.signAndCreate('n6ge8i9q4b4b5vb6.h40d7vrwir2oxlnn.v1.d.beameio.net',null);

// const crypto = require('crypto');
// crypto.randomBytes(128, (err, buf) => {
// 	if (err) throw err;
// 	console.log(`${buf.length} bytes of random data: ${buf.toString('hex')}`);
// });
// const ProvisionApi = require('../../src/services/ProvisionApi');
//
// var provisionApi = new ProvisionApi();
//
// const AuthToken = require('../../src/services/AuthToken');
//
// var fqdn =  'j8t0b43vpizea45z.q40y88v6zd30c9b6.v1.d.beameio.net';
//
// const store = new(require('../../src/services/BeameStoreV2'))();
// var cred = store.getCredential(fqdn);
//
// let authToken = AuthToken.create({fqdn},cred);
//
// provisionApi.postRequest('https://bl4liycf551p6xaz.v1.p.beameio.net/api/v1/node/delete',{fqdn},function () {
//
// },authToken);
// provisionApi.postRequest('https://t24w58ow5jkkmkhu.mpk3nobb568nycf5.v1.d.beameio.net/v1/dns/host/'+ fqdn,{fqdn},function () {
//
// });

//
// provisionApi.postRequest('https://v0cdyyss3lms2wjo.v1.p.beameio.net/api/v1/node/register',{},(error,data)=>{
//
// },python_signature);
//

//
// cred.createEntityWithLocalCreds(fqdn,'huy1','huy+1@beame.io').then(data=>{
// 	console.log(data);
// }).catch(error=>{
// 	console.error(error);
// });

// cred.getMetadata(fqdn).then(payload => {
//
// 	store.find('nlrdp710b2gqxvdh.v1.p.beameio.net').then(creds=>{
// 		if (!creds) {
// 			console.error(`Creds for ${fqdn} not found`);
// 			return;
// 		}
// 		creds.beameStoreServices.writeMetadataSync(payload);
// 	}).catch(error=>{
// 		console.error(error);
// 	});
// });

//
// cred.signWithFqdn(fqdn,"huy").then(signature=>{
// 	"use strict";
// 	ProvisionApi.getRequest('https://prov-staging.beameio.net/api/v1/node/get/meta',function (error,data) {
// 		console.log(arguments);
// 	},signature);
// }).catch(error=>{
// 	"use strict";
// 	console.error(error);
// });

//region Add Policy
// var cred = new(require('../../../src/services/Credential'))(new(require('../../../src/services/BeameStoreV2'))());
// var fqdn = 'am53rz8o6cjsm0xm.gjjpak0yxk8jhlxv.v1.p.beameio.net';
// cred.signWithFqdn(fqdn,"huy").then(signature=>{
// 	"use strict";
// 	provisionApi.postRequest('https://prov-staging.beameio.net/api/v1/node/policy/add',{policy:3,fqdn:fqdn},function (error,data) {
// 		console.log(arguments);
// 	},signature);
// }).catch(error=>{
// 	"use strict";
// 	console.error(error);
// });
//endregion


// var crypto = require('../../../src/cli/crypto');
//
// var sign = crypto.sign('huy','p2payp4q8f5ruo22.q6ujqecc83gg6fod.v1.d.beameio.net')
//
// console.log(sign)

// var devServ = new(require('../../../src/core/EntityServices'))();
// //{name:'Beame',email:'zenit1+23@beame.io'}
// devServ.registerEntity({parent_fqdn:'h40d7vrwir2oxlnn.mpk3nobb568nycf5.v1.d.beameio.net',name:'Instance Information Services'},function(error,data){
// 	if(error){
// 		console.error(error);
// 		return;
// 	}
//
// 	// devServ.completeEntityRegistration(data,function () {
// 	//
// 	// })
// });

// var store = new(require('../../../src/services/BeameStoreV2'))();
//
//
// store.getRemoteCreds('mpk3nobb568nycf5.v1.d.beameio.net').then(function onSuccess(data){
// 	"use strict";
// 	console.log(data);
// },function onError(error){
// 	"use strict";
// 	console.error(error);
// });

//  var srv = require('../../../src/cli/servers');
//
// srv.launchChat('bqnp2d2beqol13qn.h40d7vrwir2oxlnn.v1.d.beameio.net');

// var provApi = new(require('../../../src/services/ProvisionApi'))();
//
// var fqdn = 'a0xgn83l0181v9ad.xhyiac5zgewxhvl4.v1.l.d.beameio.net';
//
// var remoteCertPath = config.CertEndpoint + '/' + fqdn + '/' + 'metadata.json';
//
// provApi.getRequest(remoteCertPath,function(error,data){
// 	"use strict";
// 	console.log(data);
// });

// var securityPolicy = config.SecurityPolicy;
//
// var state, creds = [securityPolicy.Basic,securityPolicy.CanHasChildren];
//
// //creds.map(cred=> state = state | cred);
//
// var Identity = require('../../../src/core/BeameEntityServices');
//
// var identity = new Identity(config.IdentityType.Developer,null,creds);

//var state = securityPolicy.TopLevel | securityPolicy.CanHasChildren | securityPolicy.CanAuthorize;

//state = (state & securityPolicy.CanAuthorize) > 0 ?  state ^ securityPolicy.CanAuthorize : state;

//console.log(state);


// var network = require('network');
// var os = require('os');
//
// function getLocalIps() {
//
// 	var ifaces = os.networkInterfaces();
//
// 	Object.keys(ifaces).forEach(function (ifname) {
//
// 		ifaces[ifname].forEach(function (iface) {
// 			if(iface.family === 'IPv4' && iface.internal === false)
// 			console.log('os interface  %j',iface)
// 		});
// 	});
//
// }
//
// network.get_interfaces_list(function (error, list) {
// 	if (!error) {
// 		for (var i = 0; i < list.length; i++) {
// 			var ifname = list[i];
// 			console.log('interface N %j: %j',i,ifname)
// 		}
//
// 		console.log('-------------------------');
//
// 		getLocalIps();
//
// 	}
// 	else {
// 		console.error(error);
// 	}
// });


